---
title: Java内存模型三（顺序一致性）
date: 2019-05-29 23:37:00
tags:
- Java
- 并发
- 多线程
categories:
- 并发编程
---

**顺序一致性内存模型** 是一个理论参考模型。**处理器的内存模型** 和 **编程语言的内存模型** 都会以其作为参考。

## 1、数据竞争与顺序一致性

Java内存模型规范对 **数据竞争** 的定义：
 * 在一个线程中写一个变量
 * 在另一个线程读同一个变量
 * 而且写和读没有通过同步来排序

<!-- more -->

如果一个多线程程序能正确同步，则这个程序将是一个没有数据竞争的程序。

JMM对正确同步的多线程程序的内存一致性做了如下保证：

如果程序是正确同步的，程序的执行将具有顺序一致性，即：程序的执行结果与该程序在顺序一致性内存模型中的执行结果相同。

## 2、顺序一致性内存模型 & JMM（Java内存模型）

顺序一致性内存模型的特点：
 * 1) 一个线程中的所有操作必须按照程序的顺序来执行。
 * 2) 不管程序是否同步，所有线程都只能看到一个单一的操作执行顺序。在顺序一致性内存模型中，每个操作都必须原子执行且立刻对所有线程可见。

<font color="red">**注意**：</font>**JMM中不保证每个操作立即对所有线程可见。**

未同步程序在 JMM 中不但整体的执行顺序是无序的，而且所有线程看到的操作执行顺序也可能不一致。

**JMM 的具体实现原则**：在不改变（正确同步的）程序执行结果的前提下，尽可能的为编译器和处理器提供优化。

## 3、未同步程序的执行特性

对于未同步或未正确同步的多线程程序，JMM 只提供最小安全性：线程执行时读取到的值，要么是之前某个线程写入的值，要么是默认值(0, null, false)，JMM 保证线程读操作读取到值不会凭空产生。

未同步程序在两个模型中执行的差异：

 * 1) 顺序一致性模型保证单线程内的操作会按程序的顺序执行，而 JMM 不保证单线程内的操作会按程序的顺序执行。
 * 2) 顺序一致性模型保证所有线程只能看到一致的操作执行顺序，而 JMM 不保证所有线程能看到一致的操作执行顺序。
 * 3) JMM 不保证对64位的 `long` 型和 `double` 型变量的写操作具有原子性，而顺序一致性模型保证对所有的内存读/写操作都具有原子性。

**Java语言规范鼓励但不强求 JVM 对64位的 `long` 型和 `double` 型变量的写操作具有原子性**。从 JSR-133 内存模型（JDK5）开始，仅仅只允许把一个64位 `long`/`double`型变量的写操作拆分为两个32位的写操作来执行，任何读操作在 JSR-133 中都必须具有原子性。
